const nodemailer = require("nodemailer");

const transporter = nodemailer.createTransport({
  host: "mail.fivlia.com", // Or use the server IP if given: 172.93.223.239
  port: 587,              // Use 465 for SSL (recommended)
  secure: false,         // true for port 465, false for 587
  auth: {
    user: "no-reply@fivlia.com",   // Your no-reply email
    pass: "2025@Fivlia!", 
  },
    tls: {
    rejectUnauthorized: false
  }
});

const sendVerificationEmail = async (to, firstName, lastName, storeName) => {
  try {
    await transporter.sendMail({
      from: "Fivlia <no-reply@fivlia.com>",
      to,
      subject: "Fivlia Seller Registration",
      html: `
        <h3>Hello ${firstName} ${lastName},</h3>
        <p>Thank you for registering your store <strong>${storeName}</strong> with Fivlia.</p>
        <p>Your account is under verification. You will be notified once it's approved by our team.</p>
        <p>Regards,<br/>Fivlia Team</p>
      `
    });

    console.log("Verification email sent to:", to);

  } catch (error) {
    console.error("Error sending verification email:", error);
  }
};

const sendMailContact = async (to, subject,userEmail, htmlContent) => {
  await transporter.sendMail({
    from: "Fivlia <no-reply@fivlia.com>",
    replyTo: userEmail,
    to,
    subject,
    html: htmlContent,
  });
};


module.exports = {sendVerificationEmail, sendMailContact};
     
     
     
     
     
     const order = await Order.findOne({ orderId }).populate({
        path: "addressId",
        select: "mobileNumber",
      });
      if (!order) return res.status(404).json({ message: "Order not found" });

      const user = await User.findOne({ _id: order.userId });
      if (!user) return res.status(404).json({ message: "User not found" });

      const generatedOtp = Math.floor(100000 + Math.random() * 900000);
      const mobileNumber = order.addressId?.mobileNumber || user.mobileNumber;

      const message = `Dear Customer. Your Fivlia Delivery OTP code is ${generatedOtp}. Valid for 5 minutes. Do not share with others Fivlia - Delivery in Minutes!`;

      await sendMessages(mobileNumber, message, "1707176060670565835");

      await OtpModel.findOneAndUpdate(
        { mobileNumber, orderId },
        { otp: generatedOtp, expiresAt: Date.now() + 30 * 60 * 1000 },
        { upsert: true, new: true }
      );

      const statusUpdate = await Order.findOneAndUpdate(
        { orderId },
        { orderStatus },
        { new: true }
      );

      // if (activeIntervals.has(orderId)) {
      //   clearInterval(activeIntervals.get(orderId));
      //   activeIntervals.delete(orderId);
      // }
      // await sendDriverLocationToUser(order.driver.driverId, orderId);
      // const intervalId = setInterval(() => {
      //   sendDriverLocationToUser(order.driver.driverId, orderId);
      // }, 5 * 60 * 1000);

      // activeIntervals.set(orderId, intervalId);

      return res.status(200).json({
        message: `OTP sent to ${mobileNumber}`,
        otp: generatedOtp,
        statusUpdate,
      });